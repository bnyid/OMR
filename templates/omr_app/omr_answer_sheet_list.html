{% extends 'base.html' %} {% block content %} {% load custom_filters %}

<style>
  .table th,
  .table td {
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    padding: 0.5rem;
  }
  .table thead th {
    background-color: #f8f9fa;
  }
  .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.2;
  }
  .section-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  .section-title h2 {
    margin: 0;
  }
  .card {
    margin-bottom: 2rem;
  }
  .tab-btn {
    margin-right: 0.5rem;
    padding: 0.5rem 1rem;
    cursor: pointer;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #f8f9fa;
    color: #333;
    text-decoration: none;
  }
  .tab-btn.active {
    background: #0d6efd;
    color: #fff;
    border-color: #0d6efd;
  }
  .table-container {
    margin-top: 1rem;
  }
  .actions-container {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-bottom: 0.5rem;
  }
</style>

<div class="section-title">
  <h2>OMR 목록</h2>
</div>

<!-- 탭 버튼 -->
<div>
  <a href="javascript:void(0)" id="unmatchedBtn" class="tab-btn active"
    >미매칭</a
  >
  <a href="javascript:void(0)" id="matchedBtn" class="tab-btn">매칭완료</a>
</div>

<!-- 미매칭 시험지 -->
<div class="table-container" id="unmatchedContainer">
  <div class="actions-container">
    <!-- (1) 삭제 버튼 -->
    <button
      type="button"
      class="btn btn-sm btn-danger"
      id="deleteSelectedUnmatched"
    >
      삭제
    </button>
    <!-- (2) 매칭 & 채점 버튼 -->
    <button type="button" class="btn btn-sm btn-warning" id="matchAndGradeBtn">
      매칭 & 채점
    </button>
  </div>
  <div class="card">
    <div class="card-header bg-warning bg-opacity-25">
      <h5 class="mb-0">문제지 미매칭</h5>
    </div>
    <div class="card-body p-2">
      <table class="table table-striped table-bordered mb-0">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAllUnmatched" /></th>
            <th>시험일</th>
            <th>시험 식별자</th>
            <th>반 이름</th>
            <th>OMR 이름</th>
            <th>참여 인원</th>
            <th>최근 업데이트</th>
            <th>작업</th>
          </tr>
        </thead>
        <tbody>
          {% for group in unmatched_grouped_results %}
          <tr>
            <td>
              <input
                type="checkbox"
                name="selected_exam_identifier"
                value="{{ group.exam_identifier }}"
                data-omr-name="{{ group.omr_name|default:'' }}"
                data-class-name="{{ group.class_name|default:'' }}"
              />
            </td>
            <td>{{ group.exam_date|format_date_with_day }}</td>
            <td>{{ group.exam_identifier }}</td>
            <td>{{ group.class_name|default:'-' }}</td>
            <td>{{ group.omr_name|default:'-' }}</td>
            <td>{{ group.num_attendees }}</td>
            <td>{{ group.latest_created_at|date:"Y-m-d H:i" }}</td>
            <td>
              <a
                href="{% url 'omr_app:omr_result_detail_grouped' group.exam_identifier %}"
                class="btn btn-sm btn-info"
              >
                상세
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted">
              미매칭된 시험지가 없습니다.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- 매칭 완료 시험지 -->
<div class="table-container" id="matchedContainer" style="display: none">
  <div class="actions-container">
    <!-- 삭제 버튼 -->
    <button
      type="button"
      class="btn btn-sm btn-danger"
      id="deleteSelectedMatched"
    >
      삭제
    </button>
    <!-- (주의) 여긴 이미 채점이 끝났다고 가정 → 별도 버튼 없음 -->
  </div>
  <div class="card">
    <div class="card-header bg-success bg-opacity-25">
      <h5 class="mb-0">문제지 매칭완료</h5>
    </div>
    <div class="card-body p-2">
      <table class="table table-striped table-bordered mb-0">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAllMatched" /></th>
            <th>시험일</th>
            <th>시험 식별자</th>
            <th>반 이름</th>
            <th>OMR 이름</th>
            <th>참여 인원</th>
            <th>최근 업데이트</th>
            <th>작업</th>
          </tr>
        </thead>
        <tbody>
          {% for group in matched_grouped_results %}
          <tr>
            <td>
              <input
                type="checkbox"
                name="selected_exam_identifier"
                value="{{ group.exam_identifier }}"
                data-omr-name="{{ group.omr_name|default:'' }}"
                data-class-name="{{ group.class_name|default:'' }}"
              />
            </td>
            <td>{{ group.exam_date|format_date_with_day }}</td>
            <td>{{ group.exam_identifier }}</td>
            <td>{{ group.class_name|default:'-' }}</td>
            <td>{{ group.omr_name|default:'-' }}</td>
            <td>{{ group.num_attendees }}</td>
            <td>{{ group.latest_created_at|date:"Y-m-d H:i" }}</td>
            <td>
              <a
                href="{% url 'omr_app:omr_result_detail_grouped' group.exam_identifier %}"
                class="btn btn-sm btn-info"
              >
                상세
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted">
              매칭된 시험지가 없습니다.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // 탭 전환 로직
  const unmatchedBtn = document.getElementById("unmatchedBtn");
  const matchedBtn = document.getElementById("matchedBtn");
  const unmatchedContainer = document.getElementById("unmatchedContainer");
  const matchedContainer = document.getElementById("matchedContainer");

  unmatchedBtn.addEventListener("click", () => {
    unmatchedContainer.style.display = "block";
    matchedContainer.style.display = "none";
    unmatchedBtn.classList.add("active");
    matchedBtn.classList.remove("active");
  });

  matchedBtn.addEventListener("click", () => {
    unmatchedContainer.style.display = "none";
    matchedContainer.style.display = "block";
    matchedBtn.classList.add("active");
    unmatchedBtn.classList.remove("active");
  });

  // 전체선택 체크박스
  document
    .getElementById("selectAllUnmatched")
    .addEventListener("change", function () {
      const checkboxes = unmatchedContainer.querySelectorAll(
        'input[name="selected_exam_identifier"]'
      );
      checkboxes.forEach((cb) => (cb.checked = this.checked));
    });
  document
    .getElementById("selectAllMatched")
    .addEventListener("change", function () {
      const checkboxes = matchedContainer.querySelectorAll(
        'input[name="selected_exam_identifier"]'
      );
      checkboxes.forEach((cb) => (cb.checked = this.checked));
    });

  // 삭제 로직
  function deleteSelected(containerId) {
    const container = document.getElementById(containerId);
    const selected = container.querySelectorAll(
      'input[name="selected_exam_identifier"]:checked'
    );
    if (selected.length === 0) {
      alert("선택된 시험지가 없습니다.");
      return;
    }
    if (
      !confirm(
        "선택한 시험지를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다."
      )
    ) {
      return;
    }

    const formData = new FormData();
    selected.forEach((cb) => {
      formData.append("selected_exam_identifier", cb.value);
      formData.append("selected_omr_name", cb.getAttribute("data-omr-name"));
      formData.append(
        "selected_class_name",
        cb.getAttribute("data-class-name")
      );
    });

    fetch("{% url 'omr_app:bulk_omr_delete' %}", {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
      },
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.status === "success") {
          window.location.reload();
        } else {
          alert(data.message || "삭제 중 오류가 발생했습니다.");
        }
      })
      .catch((err) => {
        console.error(err);
        alert("서버 오류가 발생했습니다.");
      });
  }

  document
    .getElementById("deleteSelectedUnmatched")
    .addEventListener("click", () => {
      deleteSelected("unmatchedContainer");
    });
  document
    .getElementById("deleteSelectedMatched")
    .addEventListener("click", () => {
      deleteSelected("matchedContainer");
    });

  // (A) "매칭 & 채점" 버튼 예시
  document.getElementById("matchAndGradeBtn").addEventListener("click", () => {
    const container = document.getElementById("unmatchedContainer");
    const selected = container.querySelectorAll(
      'input[name="selected_exam_identifier"]:checked'
    );
    if (selected.length === 0) {
      alert("매칭&채점할 시험지를 선택하세요.");
      return;
    }

    // 예: 한번에 여러 exam_identifier를 보낼 수도 있고, 우선 첫번째만 처리 등...
    const formData = {
      exam_identifier_list: [],
    };
    selected.forEach((cb) => {
      formData.exam_identifier_list.push(cb.value);
    });

    // 실제 로직
    if (!confirm("선택된 시험지를 매칭 후 채점을 진행하시겠습니까?")) {
      return;
    }

    // Ajax POST: 매칭 + 채점을 처리할 뷰에 요청
    fetch("{% url 'omr_app:match_and_grade' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json",
      },
      body: JSON.stringify(formData),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.status === "success") {
          alert("매칭 & 채점이 완료되었습니다.");
          window.location.reload();
        } else {
          alert(data.message || "매칭 & 채점 중 오류가 발생했습니다.");
        }
      })
      .catch((err) => {
        console.error(err);
        alert("서버 오류가 발생했습니다.");
      });
  });
</script>
{% endblock %}
