{% extends 'base.html' %} {% block content %} {% load custom_filters %}
<style>
  .table th,
  .table td {
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    padding: 0.5rem;
  }

  .table thead th {
    background-color: #f8f9fa;
  }

  .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.2;
  }

  .section-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  .section-title h2 {
    margin: 0;
  }

  .card {
    margin-bottom: 2rem;
  }

  /* 활성화된 탭 버튼 스타일 */
  .tab-btn {
    margin-right: 0.5rem;
    padding: 0.5rem 1rem;
    cursor: pointer;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #f8f9fa;
    color: #333;
    text-decoration: none;
  }

  .tab-btn.active {
    background: #0d6efd;
    color: #fff;
    border-color: #0d6efd;
  }

  .table-container {
    margin-top: 1rem;
  }

  /* 우측 상단 버튼 컨테이너 */
  .actions-container {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 0.5rem;
  }
</style>

<div class="section-title">
  <h2>OMR 목록</h2>
</div>

<!-- 탭 버튼 -->
<div>
  <a href="javascript:void(0)" id="unmatchedBtn" class="tab-btn active"
    >unmatched</a
  >
  <a href="javascript:void(0)" id="matchedBtn" class="tab-btn">matched</a>
</div>

<!-- 테이블 컨테이너들 -->
<div class="table-container" id="unmatchedContainer">
  <div class="actions-container">
    <button
      type="button"
      class="btn btn-sm btn-danger"
      id="deleteSelectedUnmatched"
    >
      삭제
    </button>
  </div>
  <div class="card">
    <div class="card-header bg-warning bg-opacity-25">
      <h5 class="mb-0">문제지 미매칭</h5>
    </div>
    <div class="card-body p-2">
      <table class="table table-striped table-bordered mb-0">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAllUnmatched" /></th>
            <th>시험일</th>
            <th>시험 식별자</th>
            <th>반 이름</th>
            <th>OMR 이름</th>
            <th>참여 인원</th>
            <th>최근 업데이트</th>
            <th>작업</th>
          </tr>
        </thead>
        <tbody>
          {% for group in unmatched_grouped_results %}
          <tr>
            <td>
              <input
                type="checkbox"
                name="selected_exam_identifier"
                value="{{ group.exam_identifier }}"
                data-omr-name="{{ group.omr_name|default:'' }}"
                data-class-name="{{ group.class_name|default:'' }}"
              />
            </td>
            <td>{{ group.exam_date|format_date_with_day }}</td>
            <td>{{ group.exam_identifier }}</td>
            <td>{{ group.class_name|default:'-' }}</td>
            <td>{{ group.omr_name|default:'-' }}</td>
            <td>{{ group.num_attendees }}</td>
            <td>{{ group.latest_created_at|date:"Y-m-d H:i" }}</td>
            <td>
              <a
                href="{% url 'omr_app:omr_result_detail_grouped' group.exam_identifier %}"
                class="btn btn-sm btn-info"
                >상세</a
              >
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted">
              미매칭된 시험지가 없습니다.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="table-container" id="matchedContainer" style="display: none">
  <div class="actions-container">
    <button
      type="button"
      class="btn btn-sm btn-danger"
      id="deleteSelectedMatched"
    >
      삭제
    </button>
  </div>
  <div class="card">
    <div class="card-header bg-success bg-opacity-25">
      <h5 class="mb-0">문제지 매칭완료</h5>
    </div>
    <div class="card-body p-2">
      <table class="table table-striped table-bordered mb-0">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAllMatched" /></th>
            <th>시험일</th>
            <th>시험 식별자</th>
            <th>반 이름</th>
            <th>OMR 이름</th>
            <th>참여 인원</th>
            <th>최근 업데이트</th>
            <th>작업</th>
          </tr>
        </thead>
        <tbody>
          {% for group in matched_grouped_results %}
          <tr>
            <td>
              <input
                type="checkbox"
                name="selected_exam_identifier"
                value="{{ group.exam_identifier }}"
                data-omr-name="{{ group.omr_name|default:'' }}"
                data-class-name="{{ group.class_name|default:'' }}"
              />
            </td>
            <td>{{ group.exam_date|format_date_with_day }}</td>
            <td>{{ group.exam_identifier }}</td>
            <td>{{ group.class_name|default:'-' }}</td>
            <td>{{ group.omr_name|default:'-' }}</td>
            <td>{{ group.num_attendees }}</td>
            <td>{{ group.latest_created_at|date:"Y-m-d H:i" }}</td>
            <td>
              <a
                href="{% url 'omr_app:omr_result_detail_grouped' group.exam_identifier %}"
                class="btn btn-sm btn-info"
                >상세</a
              >
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted">
              매칭된 시험지가 없습니다.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const unmatchedBtn = document.getElementById("unmatchedBtn");
  const matchedBtn = document.getElementById("matchedBtn");
  const unmatchedContainer = document.getElementById("unmatchedContainer");
  const matchedContainer = document.getElementById("matchedContainer");

  unmatchedBtn.addEventListener("click", () => {
    unmatchedContainer.style.display = "block";
    matchedContainer.style.display = "none";
    unmatchedBtn.classList.add("active");
    matchedBtn.classList.remove("active");
  });

  matchedBtn.addEventListener("click", () => {
    unmatchedContainer.style.display = "none";
    matchedContainer.style.display = "block";
    matchedBtn.classList.add("active");
    unmatchedBtn.classList.remove("active");
  });

  // 전체 선택 체크박스: 미매칭
  document
    .getElementById("selectAllUnmatched")
    .addEventListener("change", function () {
      const checkboxes = unmatchedContainer.querySelectorAll(
        'input[name="selected_exam_identifier"]'
      );
      checkboxes.forEach((cb) => (cb.checked = this.checked));
    });

  // 전체 선택 체크박스: 매칭
  document
    .getElementById("selectAllMatched")
    .addEventListener("change", function () {
      const checkboxes = matchedContainer.querySelectorAll(
        'input[name="selected_exam_identifier"]'
      );
      checkboxes.forEach((cb) => (cb.checked = this.checked));
    });

  // 삭제 함수 공통화
  function deleteSelected(containerId) {
    const container = document.getElementById(containerId);
    const selected = container.querySelectorAll(
      'input[name="selected_exam_identifier"]:checked'
    );
    if (selected.length === 0) {
      alert("선택된 시험지가 없습니다.");
      return;
    }
    if (
      !confirm(
        "선택한 시험지를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다."
      )
    )
      return;

    const formData = new FormData();
    selected.forEach((cb) => {
      formData.append("selected_exam_identifier", cb.value);
      formData.append("selected_omr_name", cb.getAttribute("data-omr-name"));
      formData.append(
        "selected_class_name",
        cb.getAttribute("data-class-name")
      );
    });

    fetch("{% url 'omr_app:bulk_omr_delete' %}", {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          window.location.reload();
        } else {
          alert(data.message || "삭제 중 오류가 발생했습니다.");
        }
      })
      .catch((err) => {
        console.error(err);
        alert("서버 오류가 발생했습니다.");
      });
  }

  // 삭제 버튼 클릭(미매칭)
  document
    .getElementById("deleteSelectedUnmatched")
    .addEventListener("click", () => {
      deleteSelected("unmatchedContainer");
    });

  // 삭제 버튼 클릭(매칭)
  document
    .getElementById("deleteSelectedMatched")
    .addEventListener("click", () => {
      deleteSelected("matchedContainer");
    });
</script>

{% endblock %}
