{% extends 'base.html' %} {% block content %}

<style>
  input[type="checkbox"] {
    width: 13px;
    height: 13px;
    cursor: pointer;
    transform: scale(1.5);
  }
  .editable:hover {
    background-color: #f8f9fa;
    cursor: pointer;
  }
  .editing {
    padding: 0 !important;
  }
  /* 입력 필드와 select 요소 스타일 수정 */
  .form-control-sm,
  select.form-control-sm,
  input[type="date"].form-control-sm,
  input[type="text"].form-control-sm {
    width: 100%;
    min-width: 80px;
    height: 31px !important;
    border: 1px solid #0d6efd;
    padding: 0.25rem 0.5rem !important;
    text-align: center !important;
    margin: 0 !important;
    box-sizing: border-box !important;
    display: block !important;
  }
  /* 테이블 가운데 정렬을 위한 스타일 */
  .table th,
  .table td {
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    height: 31px !important;
    padding: 0.25rem 0.5rem !important;
    box-sizing: border-box !important;
    width: 1% !important; /* 셀 너비를 내용에 맞게 최소화 */
  }
  /* 편집 모드일 때의 td 스타일 */
  .table td.editing {
    padding: 0 !important;
    height: 31px !important;
    width: 1% !important;
  }
  /* 버튼 컨테이너 스타일 */
  .button-container {
    white-space: nowrap;
  }
  /* 버튼 크기 조정 */
  .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.2;
  }
  .new-student-row input[type="text"],
  .new-student-row input[type="date"],
  .new-student-row input[type="tel"],
  .new-student-row select {
    width: 100%;
    min-width: 80px;
    height: 31px !important;
    border: 1px solid #0d6efd;
    padding: 0.25rem 0.5rem !important;
    text-align: center !important;
    margin: 0 !important;
    box-sizing: border-box !important;
  }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>학생 목록</h2>
  <div>
    <button type="button" class="btn btn-warning me-2" value="update">
      일괄 변경
    </button>
    <button type="button" class="btn btn-primary me-2" id="addRowBtn">
      학생 추가
    </button>
    <button
      type="submit"
      name="action"
      value="delete"
      class="btn btn-danger"
      form="bulkActionForm"
    >
      학생 삭제
    </button>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <form
      id="bulkActionForm"
      method="post"
      action="{% url 'omr_app:bulk_action' %}"
    >
      {% csrf_token %}
      <table class="table table-striped">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" /></th>
            <th>등록일</th>
            <th>등록번호</th>
            <th>학번</th>
            <th>이름</th>
            <th>소속반</th>
            <th>학교명</th>
            <th>학년</th>
            <th>연락처</th>
            <th>연락처_보호자</th>
            <th>비고</th>
            <th>작업</th>
          </tr>
        </thead>
        <tbody>
          {% for student in students %}
          <tr data-student-id="{{ student.id }}">
            <td>
              <input
                type="checkbox"
                name="selected_students"
                value="{{ student.id }}"
              />
            </td>
            <td class="editable" data-field="registered_date">
              {{ student.registered_date|date:"Y-m-d"|default:'-' }}
            </td>
            <td>{{ student.registration_number|default:'-' }}</td>
            <td class="editable" data-field="student_code">
              {{ student.student_code|default:'-' }}
            </td>
            <td class="editable" data-field="name">
              {{ student.name|default:'-' }}
            </td>
            <td class="editable" data-field="class_name">
              {{ student.class_name|default:'-' }}
            </td>
            <td class="editable" data-field="school_name">
              {{ student.school_name|default:'-' }}
            </td>
            <td class="editable" data-field="grade">
              {{ student.grade|default:'-' }}
            </td>
            <td class="editable" data-field="phone_number">
              {{ student.phone_number|default:'-' }}
            </td>
            <td class="editable" data-field="parent_phone">
              {{ student.parent_phone|default:'-' }}
            </td>
            <td class="editable" data-field="note">
              {{ student.note|default:'-' }}
            </td>
            <td class="button-container">
              <a
                href="{% url 'omr_app:student_detail' student.id %}"
                class="btn btn-sm btn-info me-1"
                >상세</a
              >
              <button
                type="button"
                class="btn btn-sm btn-warning me-1 edit-mode-btn"
              >
                수정
              </button>
              <button
                type="button"
                class="btn btn-sm btn-success me-1 save-row"
                style="display: none"
              >
                저장
              </button>
              <button
                type="button"
                class="btn btn-sm btn-secondary cancel-edit"
                style="display: none"
              >
                취소
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </form>
  </div>
</div>

<script>
  $(document).ready(function () {
    // DataTable 초기화
    $("#studentTable").DataTable({
      language: {
        url: "//cdn.datatables.net/plug-ins/1.11.5/i18n/ko.json",
      },
      order: [[0, "desc"]], // 등록일 기준 내림차순 정렬
      pageLength: 25,
    });

    // 학생 추가 버튼 클릭 시
    $("#addRowBtn").click(function () {
      // id가 addRowBtn인 요소를 클릭했을 때, 해당 이벤트 객체를 매개변수로 받아 {}안에 있는 function들을 실행한다.
      const newRow = `
            <tr class="new-student-row">
                <td><input type="checkbox" name="selected_students" disabled></td>
                <td><input type="date" class="form-control form-control-sm" name="registered_date"></td>
                <td></td>
                <td><input type="text" class="form-control form-control-sm" name="student_code" maxlength="8"></td>
                <td><input type="text" class="form-control form-control-sm" name="name" maxlength="10" required></td>
                <td><input type="text" class="form-control form-control-sm" name="class_name"></td>
                <td><input type="text" class="form-control form-control-sm" name="school_name"></td>
                <td>
                    <select class="form-control form-control-sm" name="grade">
                        <option value=""></option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                </td>
                <td><input type="tel" class="form-control form-control-sm" name="phone_number"></td>
                <td><input type="tel" class="form-control form-control-sm" name="parent_phone"></td>
                <td><input type="text" class="form-control form-control-sm" name="note"></td>
                <td class="button-container">
                    <button type="button" class="btn btn-sm btn-success me-1 save-new-row">저장</button>
                    <button type="button" class="btn btn-sm btn-secondary cancel-new-row">취소</button>
                </td>
            </tr>
        `;
      $("table tbody").append(newRow);

      // 새로 추가된 행의 모든 input과 select 요소에 대해 Enter 키 이벤트 핸들러 추가
      $(".new-student-row") // 클래스가 new-student-row인 요소를 찾아서
        .find("input, select") // 그 요소 내부에서 input과 select 요소를 찾아서
        .on("keydown", function (e) {
          // 그 요소에서 키가 눌렸을때(=keydown이벤트), 해당 이벤트 객체를 매개변수로 받아 {}안에 있는 function들을 실행한다.
          if (e.which === 13) {
            // 눌러진 키의 코드(which)가 enter키(13)와 같으면
            e.preventDefault(); // 기본 동작 방지
            $(this).closest("tr").find(".save-new-row").click(); // 가장 가까운 <tr> 태그 내부에서 save-new-row클래스 요소를 찾아서 클릭
          }
        });
    });

    // 새 행 취소 버튼 클릭 시
    $(document).on("click", ".cancel-new-row", function () {
      // cancel-new-row 클래스 요소를 클릭하면, 해당 이벤트 객체를 매개변수로 받아 {}안에 있는 function들을 실행한다.
      $(this).closest("tr").remove(); // 클릭한 요소(this)의 가장 가까운 부모 요소인 <tr>태그를 찾아서 삭제
    });

    // 새 행 저장 버튼 클릭 시
    $(document).on("click", ".save-new-row", function () {
      // save-new-row 클래스 요소를 클릭하면, 해당 이벤트 객체를 매개변수로 받아 {}안에 있는 function들을 실행한다.
      const row = $(this).closest("tr"); // 클릭한 요소(this)의 가장 가까운 부모 요소인 <tr>태그를 찾아서 row 변수에 저장
      const formData = {}; // 빈 객체를 생성하여 그릇으로 사용

      row.find("input, select").each(function () {
        formData[$(this).attr("name")] = $(this).val(); // 각 요소의 name속성과 value 속성을 찾아서 formData 객체에 키:값 형태로 추가
      });

      $.ajax({
        url: '{% url "omr_app:student_add" %}',
        method: "POST",
        data: formData,
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        },
        success: function (response) {
          if (response.status === "success") {
            location.reload();
          } else {
            alert(response.message);
          }
        },
        error: function (xhr, status, error) {
          console.error("Error:", xhr.responseText);
          alert("학생 추가 중 오류가 발생했습니다.");
        },
      });
    });

    // 삭제 버튼 클릭 시 (value="delete"인 버튼)
    $('button[value="delete"]').click(function (e) {
      e.preventDefault();

      const selectedStudents = $('input[name="selected_students"]:checked');

      if (selectedStudents.length === 0) {
        alert("선택된 학생이 없습니다.");
        return;
      }

      if (confirm("선택한 학생들을 삭제하시겠습니까?")) {
        const form = $("#bulkActionForm")[0];
        const formData = new FormData(form);
        const deleteButton = $('button[value="delete"]');
        formData.append("action", deleteButton.val());

        $.ajax({
          url: "{% url 'omr_app:bulk_action' %}", // URL 수정
          method: "POST",
          data: formData,
          processData: false,
          contentType: false,
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
          },
          success: function (response) {
            console.log("서버 응답:", response);
            if (response.status === "success") {
              window.location.reload();
            } else {
              alert(response.message || "삭제 중 오류가 발생했습니다.");
            }
          },
          error: function (xhr, status, error) {
            console.error("Error:", xhr.responseText);
            alert("서버 오류가 발생했습니다. 다시 시도해주세요.");
          },
        });
      }
    });

    // 전체 선택 체크박스 기능
    $("#selectAll").change(function () {
      $("input[name='selected_students']").prop(
        "checked",
        $(this).prop("checked")
      );
    });

    // 일괄 변경 버튼 클릭 시
    $("button[value='update']").click(function (e) {
      e.preventDefault();

      // 선택된 학생들의 ID 수집
      const selectedStudents = [];
      $("input[name='selected_students']:checked").each(function () {
        selectedStudents.push($(this).val());
      });

      if (selectedStudents.length === 0) {
        alert("변경할 학생을 선택해주세요.");
        return;
      }

      // 선택된 학생들의 ID를 hidden input으로 추가
      $("#selectedStudentsContainer").empty();
      selectedStudents.forEach(function (studentId) {
        $("#selectedStudentsContainer").append(
          `<input type="hidden" name="selected_students" value="${studentId}">`
        );
      });

      // 모달 표시
      $("#bulkUpdateModal").modal("show");
    });

    // 수정 버튼 클릭 시
    $(".edit-mode-btn").click(function () {
      const row = $(this).closest("tr");

      // 수정/상세 버튼 숨기고 저장/취소 버튼 표시
      row.find(".edit-mode-btn, .btn-info").hide();
      row.find(".save-row, .cancel-edit").show();

      // 각 셀을 입력 필드로 변환하기 전에 원본 데이터 저장
      row.find(".editable").each(function () {
        const field = $(this).data("field");
        let originalValue = $(this).text().trim();
        // "-" 값을 빈 문자열로 변환
        originalValue = originalValue === "-" ? "" : originalValue;
        row.data(`original-${field}`, originalValue);
      });

      // 각 셀을 입력 필드로 변환
      row.find(".editable").each(function () {
        let value = $(this).text().trim();
        // "-" 값을 빈 문자열로 변환
        value = value === "-" ? "" : value;
        const field = $(this).data("field");

        if (field === "grade") {
          $(this).html(`
                <select class="form-control form-control-sm">
                  <option value=""></option>
                  <option value="1" ${
                    value === "1" ? "selected" : ""
                  }>1</option>
                  <option value="2" ${
                    value === "2" ? "selected" : ""
                  }>2</option>
                  <option value="3" ${
                    value === "3" ? "selected" : ""
                  }>3</option>
                </select>
              `);
        } else if (field === "registered_date") {
          $(this).html(`
                <input type="date" class="form-control form-control-sm" value="${value}">
              `);
        } else {
          $(this).html(
            `<input type="text" class="form-control form-control-sm" value="${value}">`
          );
        }

        // Enter 키와 ESC 키 이벤트 핸들러 추가
        $(this)
          .find("input, select")
          .on("keydown", function (e) {
            if (e.which === 13) {
              // Enter 키
              e.preventDefault();
              $(this).closest("tr").find(".save-row").click();
            } else if (e.which === 27) {
              // ESC 키
              e.preventDefault();
              $(this).closest("tr").find(".cancel-edit").click();
              return false; // 이벤트 전파 중단
            }
          });
      });
    });

    // 취소 버튼 클릭 시
    $(".cancel-edit").click(function () {
      const row = $(this).closest("tr");

      // 각 셀의 원래 데이터로 복원
      row.find(".editable").each(function () {
        const field = $(this).data("field");
        let originalValue = row.data(`original-${field}`);

        // 값이 없는 경우 '-' 표시
        if (!originalValue || originalValue === "None") {
          originalValue = "-";
        }
        $(this).html(originalValue);
      });

      // 버튼 상태 복원
      row.find(".edit-mode-btn, .btn-info").show();
      row.find(".save-row, .cancel-edit").hide();
    });

    // 저장 버튼 클릭 시
    $(".save-row").click(function () {
      // save-row 라는 클래스(.)를 가진 요소를 클릭했을 때 아래 함수를 실행하라
      const row = $(this).closest("tr"); // 클릭한 요소(this)에서 가장가까운(closest) <tr>태그를 찾아서 row 변수에 저장
      const studentId = row.data("student-id"); // row 변수(=tr태그)의 data-student-id 라는 데이터 속성을 가진 요소를 찾아서 studentId 변수에 저장 (data- 형식은 다 문자열임, 비어있으면 '' 빈 문자열이 저장됨)
      const updates = {}; // 빈 객체를 생성하여 그릇으로 사용

      row.find(".editable").each(function () {
        // row 변수(=tr태그)안의 자식 요소들 중에서 editable 클래스를 모두 찾고(find) 걔네들을 각각 순회(each)하며 아래 함수를 실행하라
        const field = $(this).data("field"); // 각 요소의 data-field 라는 데이터 속성을 가진 요소를 찾아서 field 변수에 저장
        const value = $(this).find("input, select").val(); // 각 요소(여기서는 editable 클래스를 가진 요소들) 내부의 input 또는 select 태그를 찾아서(find) 그 값(val())을 value 변수에 저장
        updates[field] = value; // updates 객체에 field 변수를 키로, value 변수를 값으로 추가
      });

      $.ajax({
        // ajax 메소드를 사용하여 서버와 통신
        url: `/students/${studentId}/update/`, // 자바스크립트에서 변수를 포함하고 싶을 때 백틱(`) 사용 (파이썬의 f-string 같은 역할)
        method: "POST",
        data: updates, // x-www-form-urlencoded
        /*
    전송할 데이터 = updates 객체, type은 기본값이 x-www-form-urlencoded

    *** $.ajax()는 기본적으로 x-www-form-urlencoded 방식으로 데이터를 전송함.

    데이터 형식: key1=value1&key2=value2&key3=value3 이런식

    예시)) 만약 name=홍길동&age=20&grade=1 이 데이터를 전송 한다면
    실제 전송되는 데이터 : name=%ED%99%8D%EA%B8%B8%EB%8F%99&age=20&grade=1

    이렇게 전송된 데이터는 Django 서버에서는 request.POST로 접근함.

  cf) 반면에 파일 업로드와 같은 경우는 FormData를 사용해야 하며, 이때는 multipart/form-data 형식으로 전송
    */

        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        },
        success: function (response) {
          if (response.status === "success") {
            location.reload(); // 페이지 새로고침
          } else {
            alert(response.message); // 응답 데이터에 따른 알림창 띄우기
          }
        },
        error: function () {
          alert("저장 중 오류가 발생했습니다.");
        },
      });
    });
  });
</script>
{% endblock %}
