{% extends 'base.html' %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>학생 목록</h2>
  <button
    type="button"
    class="btn btn-primary"
    data-bs-toggle="modal"
    data-bs-target="#addStudentModal"
  >
    학생 추가
  </button>
</div>

<div class="card">
  <div class="card-body">
    <table id="studentTable" class="table table-striped">
      <thead>
        <tr>
          <th>학번</th>
          <th>이름</th>
          <th>소속반</th>
          <th>학교구분</th>
          <th>학교명</th>
          <th>학년</th>
          <th>등록일</th>
          <th>관리</th>
        </tr>
      </thead>
      <tbody>
        {% for student in students %}
        <tr>
          <td>{{ student.student_id }}</td>
          <td>{{ student.name }}</td>
          <td>{{ student.class_name }}</td>
          <td>{{ student.get_school_type_display }}</td>
          <td>{{ student.school_name }}</td>
          <td>{{ student.grade }}학년</td>
          <td>{{ student.registered_date|date:"Y-m-d" }}</td>
          <td>
            <a
              href="{% url 'omr_app:student_detail' student.student_id %}"
              class="btn btn-sm btn-info"
              >상세</a
            >
            <button
              class="btn btn-sm btn-danger delete-student"
              data-student-id="{{ student.student_id }}"
            >
              삭제
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- 학생 추가 모달 -->
<div class="modal fade" id="addStudentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <!-- 모달 헤더 : 제목과 닫기 버튼 포함 -->
        <h5 class="modal-title">학생 추가</h5>
        <!-- 우측 상단 X(닫기) 버튼 -->
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <!-- 정보 입력 폼 시작 -->
      <form id="addStudentForm">
        <!-- 폼 내용을 담는 본문 영역-->
        <div class="modal-body">
          <!-- 학번 입력 필드 : 최대 8자리 입력 가능 -->
          <div class="mb-3">
            <label class="form-label">학번</label>
            <input
              type="text"
              class="form-control"
              name="student_id"
              required
              maxlength="8"
            />
          </div>
          <!-- 이름 입력 필드 : 최대 10자리 입력 가능 -->
          <div class="mb-3">
            <label class="form-label">이름</label>
            <input
              type="text"
              class="form-control"
              name="name"
              required
              maxlength="10"
            />
          </div>
          <!-- 소속반 입력 필드 -->
          <div class="mb-3">
            <label class="form-label">소속반</label>
            <input
              type="text"
              class="form-control"
              name="class_name"
              required
            />
          </div>
          <!-- 학교구분 선택 필드 -->
          <div class="mb-3">
            <label class="form-label">학교구분</label>
            <select class="form-select" name="school_type" required>
              <option value="M">중학교</option>
              <option value="H">고등학교</option>
            </select>
          </div>
          <!-- 학년 선택 필드 -->
          <div class="mb-3">
            <label class="form-label">학년</label>
            <select class="form-select" name="grade" required>
              <option value="1">1학년</option>
              <option value="2">2학년</option>
              <option value="3">3학년</option>
            </select>
          </div>
          <!-- 학교명 입력 필드 -->
          <div class="mb-3">
            <label class="form-label">학교명</label>
            <input
              type="text"
              class="form-control"
              name="school_name"
              required
            />
          </div>
          <!-- 본인 연락처 입력 필드 -->
          <div class="mb-3">
            <label class="form-label">본인 연락처</label>
            <input
              type="tel"
              class="form-control"
              name="phone_number"
              required
            />
          </div>
          <!-- 보호자 연락처 입력 필드 -->
          <div class="mb-3">
            <label class="form-label">보호자 연락처</label>
            <input
              type="tel"
              class="form-control"
              name="parent_phone"
              required
            />
          </div>
          <!-- 비고 입력 필드 -->
          <div class="mb-3">
            <label class="form-label">비고</label>
            <textarea class="form-control" name="note" rows="3"></textarea>
          </div>
        </div>
        <!-- 폼 하단 버튼 영역 -->
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            취소
          </button>
          <button type="submit" class="btn btn-primary">저장</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    // DataTable 초기화
    $("#studentTable").DataTable({
      language: {
        url: "//cdn.datatables.net/plug-ins/1.11.5/i18n/ko.json",
      },
      order: [[1, "asc"]], // 이름 기준 오름차순 정렬
      pageLength: 25,
    });

    // 학생 추가
    $("#addStudentForm").on("submit", function (e) {
      // id가 addStudentForm인 폼에서 "submit" 이벤트 발생 시, 해당 이벤트 객체를 매개변수로 받아 {}안에 있는 function들을 실행한다.
      e.preventDefault(); // 폼의 기본 제출 동작 방지
      console.log("Form submitted"); // 폼 제출 확인용 로그

      const formData = new FormData(this); // FormData 객체에 현재 제출된 폼(this)의 모든 입력된 값들을 수집
      const formObject = {}; // 빈 객체를 생성하여 FormData의 데이터를 일반 객체로 변환해서 담을 변수를 선언
      formData.forEach((value, key) => {
        // FormData 객체의 각 키와 값을 순회하며
        formObject[key] = value; // 키와 값을 formObject에 추가
      });

      console.log("Form data:", formObject); // 전송할 데이터 확인용 로그

      // ajax = 비동기적(새로고침x)으로 서버와 통신할 때 사용하는 메소드
      $.ajax({
        url: '{% url "omr_app:student_add" %}', // 전달할 서버 주소
        method: "POST", // 요청 메소드
        data: formObject, // 전송할 데이터
        headers: {
          "X-CSRFToken": "{{ csrf_token }}", // CSRF 토큰 포함
          "Content-Type": "application/x-www-form-urlencoded", // 폼 데이터 타입 지정
        },
        success: function (response) {
          console.log("Success:", response);
          if (response.status === "success") {
            location.reload();
          } else {
            alert(response.message);
          }
        },
        error: function (xhr, status, error) {
          console.error("Error:", xhr.responseText);
          alert("학생 추가 중 오류가 발생했습니다.");
        },
      });
    });

    // 학생 삭제
    $(".delete-student").on("click", function () {
      if (confirm("정말 삭제하시겠습니까?")) {
        const studentId = $(this).data("student-id");

        fetch(`/students/${studentId}/delete/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              location.reload();
            } else {
              alert(data.message);
            }
          });
      }
    });
  });
</script>
{% endblock %}
