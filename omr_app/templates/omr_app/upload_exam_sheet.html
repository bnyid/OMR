<!-- upload_exam_sheet.html -->
{% extends "base.html" %} {% block content %}
<style>
  table td {
    white-space: normal;
    vertical-align: middle;
  }

  /* 모달 크기 확장 */
  .modal-xxl {
    max-width: 1400px;
  }

  /* 모달 높이 제한 및 스크롤 */
  .modal-body {
    max-height: 75vh; /* 가로 대비 높이비율  ex) 80vh = 80% */
    overflow-y: auto; /* 내용이 넘치면 자동으로 */
  }

  .review-row {
    display: flex;
    gap: 20px;
  }

  .review-col {
    flex: 1;
  }

  .review-section {
    margin-bottom: 15px;
  }

  .review-section hr {
    margin-top: 20px;
    margin-bottom: 20px;
  }

  .modal-header-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header-nav button {
    margin: 0 5px;
  }

  .question-separator {
    border-top: 2px solid #ddd;
    margin: 20px 0;
  }

  .editable-box {
    border: 1px solid #ccc;
    padding: 5px;
    min-height: 30px;
    background: #fff;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .editable-box p,
  .editable-box div {
    margin: 0;
    padding: 0;
    line-height: normal;
  }

  /* choices layout */
  .choice-line {
    display: flex;
    align-items: start;
    gap: 5px;
    margin-bottom: 5px;
  }

  /* choice editable-box 전체 너비 사용 */
  .choice-line .editable-box {
    width: 100%;
  }
</style>

<div class="row justify-content-start">
  <div class="col-md-12">
    <div class="card mb-3">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h3 class="card-title mb-0">시험지 업로드</h3>
        <button
          id="reviewBtn"
          class="btn btn-secondary btn-sm"
          style="margin-left: 10px"
        >
          검토
        </button>
      </div>
      <div class="card-body">
        <form id="examUploadForm" enctype="multipart/form-data" method="post">
          {% csrf_token %}
          <div class="d-flex gap-2">
            <div class="flex-grow-1">
              <input
                type="file"
                id="hwp_file"
                class="form-control"
                name="hwp_file"
                accept=".hwp,.hwpx"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary">처리하기</button>
          </div>
        </form>
        <div id="extractResult" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<div class="text-end mb-3">
  <button id="finalSubmitBtn" class="btn btn-success">최종 제출</button>
</div>

<table id="examTable" class="table table-striped table-bordered mt-3">
  <thead>
    <tr>
      <th class="text-center">p_num</th>
      <th class="text-center">p_seri</th>
      <th class="text-center">p_source</th>
      <th class="text-center">q_num</th>
      <th class="text-center">g_num</th>
      <th class="text-center">q_type_q_score</th>
      <th class="text-center">ans</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- 최종 제출 모달 -->
<div
  class="modal fade"
  id="finalExamNameModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">시험명 입력</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="examNameInput" class="form-label">시험명</label>
          <input
            type="text"
            id="examNameInput"
            placeholder="시험 이름 입력"
            class="form-control"
          />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          취소
        </button>
        <button id="finalConfirmBtn" class="btn btn-success">제출</button>
      </div>
    </div>
  </div>
</div>

<!-- 검토 모달 -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xxl">
    <div class="modal-content">
      <div class="modal-header modal-header-nav">
        <button id="prevPassageBtn" class="btn btn-outline-primary btn-sm">
          &lt;-
        </button>
        <h5 class="modal-title">지문 검토/수정</h5>
        <button id="nextPassageBtn" class="btn btn-outline-primary btn-sm">
          -&gt;
        </button>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <!-- 첫 행: p_num, p_source, is_double_question -->
        <div class="review-section">
          <div class="d-flex align-items-center mb-2" style="gap: 10px">
            <div>
              <label>p_num</label>
              <input
                type="text"
                id="reviewPnum"
                class="form-control form-control-sm"
                style="width: 60px"
                readonly
              />
            </div>
            <div>
              <label>p_source</label>
              <input
                type="text"
                id="reviewSource"
                class="form-control form-control-sm"
              />
            </div>
            <div>
              <label>is_double_question</label>
              <input
                type="text"
                id="reviewDouble"
                class="form-control form-control-sm"
                readonly
              />
            </div>
          </div>
        </div>

        <div id="dynamicRowContainer"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          닫기
        </button>
        <button id="saveReviewChangesBtn" class="btn btn-primary">
          변경사항 저장
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let extractedData = null;
  let currentPassageIndex = 0;

  document
    .getElementById("examUploadForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const response = await fetch("{% url 'omr_app:upload_exam' %}", {
        method: "POST",
        body: formData,
      });

      const data = await response.json();
      if (data.status === "success") {
        extractedData = data.data;
        renderExamTable(extractedData);
      } else {
        alert("오류 발생: " + data.message);
      }
    });

  function renderExamTable(data) {
    const tbody = document.querySelector("#examTable tbody");
    tbody.innerHTML = "";

    data.forEach((passage) => {
      const passageNumber = passage.passage_number || "";
      const passageSerial = passage.passage_serial || "";
      const passageSource = passage.passage_source || "";

      const questionList = passage.question_list || [];

      questionList.forEach((question, qIndex) => {
        const rowSpan =
          questionList.length > 1 ? `rowspan="${questionList.length}"` : "";
        const multiRowClass = questionList.length > 1 ? "multi-row-cell" : "";

        const questionNumber = question.question_number || "";
        const gradingNumber =
          question.grading_number !== undefined ? question.grading_number : "";
        const questionType = question.question_type || "";
        const questionScore =
          question.score !== undefined ? question.score : "";
        const ans = question.answer !== undefined ? question.answer : "";
        const qTypeScoreDisplay =
          questionType + (questionScore ? `(${questionScore})` : "");

        const tr = document.createElement("tr");
        if (qIndex === 0) {
          tr.innerHTML += `
            <td class="text-center ${multiRowClass}" ${rowSpan}>${passageNumber}</td>
            <td class="text-center ${multiRowClass}" ${rowSpan}>${passageSerial}</td>
            <td class="text-center ${multiRowClass}" ${rowSpan}>${passageSource}</td>
          `;
        }

        tr.innerHTML += `
          <td class="text-center">${questionNumber}</td>
          <td class="text-center">${gradingNumber}</td>
          <td class="text-center">${qTypeScoreDisplay}</td>
          <td class="text-center">${ans}</td>
        `;
        tbody.appendChild(tr);
      });
    });
  }

  document.getElementById("reviewBtn").addEventListener("click", () => {
    if (!extractedData || extractedData.length === 0) {
      alert("먼저 시험지를 업로드해주세요.");
      return;
    }
    currentPassageIndex = 0;
    showPassageInReviewModal(currentPassageIndex);
    const modal = new bootstrap.Modal(document.getElementById("reviewModal"));
    modal.show();
  });

  document.getElementById("prevPassageBtn").addEventListener("click", () => {
    if (!extractedData) return;
    if (currentPassageIndex > 0) {
      saveCurrentModalChanges();
      currentPassageIndex--;
      showPassageInReviewModal(currentPassageIndex);
    }
  });

  document.getElementById("nextPassageBtn").addEventListener("click", () => {
    if (!extractedData) return;
    if (currentPassageIndex < extractedData.length - 1) {
      saveCurrentModalChanges();
      currentPassageIndex++;
      showPassageInReviewModal(currentPassageIndex);
    }
  });

  function showPassageInReviewModal(index) {
    const passage = extractedData[index];

    document.getElementById("reviewPnum").value = passage.passage_number;
    document.getElementById("reviewSource").value =
      passage.passage_source || "";
    document.getElementById("reviewDouble").value = passage.is_double_question
      ? "True"
      : "False";

    const dynamicRowContainer = document.getElementById("dynamicRowContainer");
    dynamicRowContainer.innerHTML = "";

    // 항상 3단 레이아웃
    const rowDiv = document.createElement("div");
    rowDiv.classList.add("review-row", "review-section");
    dynamicRowContainer.appendChild(rowDiv);

    const passageTableHTML = passage.passage_table || "";
    const passageTableBlock = passageTableHTML
      ? `
        <label class="mt-2">passage_table (HTML)</label>
        <div id="reviewPassageTable" class="editable-box" contenteditable="true">${passageTableHTML}</div>
      `
      : "";

    const leftCol = document.createElement("div");
    leftCol.classList.add("review-col");
    leftCol.innerHTML = `
      <label>passage_text</label>
      <div id="reviewPassageText" class="editable-box" contenteditable="true">${
        passage.passage_text || ""
      }</div>
      ${passageTableBlock}
    `;
    rowDiv.appendChild(leftCol);

    const questionList = passage.question_list || [];

    const middleCol = document.createElement("div");
    middleCol.classList.add("review-col");
    rowDiv.appendChild(middleCol);

    if (questionList.length > 0) {
      const qWrap1 = createQuestionHtml(questionList[0]);
      middleCol.innerHTML = qWrap1;
    }

    const rightCol = document.createElement("div");
    rightCol.classList.add("review-col");
    rowDiv.appendChild(rightCol);

    if (questionList.length > 1) {
      const qWrap2 = createQuestionHtml(questionList[1]);
      rightCol.innerHTML = qWrap2;
    }
  }

  function createQuestionHtml(question) {
    const qTableHTML = (question.question_table || []).join("<hr>");
    const qTableBlock = qTableHTML
      ? `
        <div class="mb-2">
          <label>question_table</label>
          <div class="editable-box" contenteditable="true">${qTableHTML}</div>
        </div>
      `
      : "";

    const answerHTML = question.answer !== undefined ? question.answer : "";
    const explanationHTML = question.explanation || "";

    const fullChoices = question.choice_list || [];
    const numChoices = 5;
    let choicesRows = "";
    for (let i = 0; i < numChoices; i++) {
      const c = fullChoices[i];
      const cText = c ? c.choice_text : "";
      // 인덱스 라벨 제거, 단순히 editable-box만
      choicesRows += `
        <div class="choice-line">
          <div class="editable-box" contenteditable="true">${cText}</div>
        </div>
      `;
    }

    const choicesBlock = `
      <div class="mb-2">
        <label>q_choices</label>
        ${choicesRows}
      </div>
    `;

    return `
      <div class="review-section">
        <h6>문제 ${question.question_number} ${
      question.is_essay ? "(논술)" : "(객관)"
    }</h6>
        <div class="mb-2">
          <label>question_text</label>
          <div class="editable-box" contenteditable="true">${
            question.question_text || ""
          }</div>
        </div>
        ${qTableBlock}
        ${choicesBlock}
        <h6>정답/해설 - 문제 ${question.question_number}</h6>
        <div class="mb-2">
          <label>answer</label>
          <div class="editable-box" contenteditable="true">${answerHTML}</div>
        </div>
        <div class="mb-2">
          <label>explanation</label>
          <div class="editable-box" contenteditable="true">${explanationHTML}</div>
        </div>
      </div>
    `;
  }

  function saveCurrentModalChanges() {
    const passage = extractedData[currentPassageIndex];
    passage.passage_source = document
      .getElementById("reviewSource")
      .value.trim();
    passage.passage_text =
      document.getElementById("reviewPassageText").innerHTML;
    const passageTableElem = document.getElementById("reviewPassageTable");
    passage.passage_table = passageTableElem
      ? passageTableElem.innerHTML
      : null;
    // question등은 필요하다면 추출 로직 추가
  }

  document
    .getElementById("saveReviewChangesBtn")
    .addEventListener("click", () => {
      saveCurrentModalChanges();
      alert("변경사항이 저장되었습니다. (단, 실제 서버 반영은 최종 제출 시)");
    });

  document.getElementById("finalSubmitBtn").addEventListener("click", () => {
    const modal = new bootstrap.Modal(
      document.getElementById("finalExamNameModal")
    );
    modal.show();
  });

  document
    .getElementById("finalConfirmBtn")
    .addEventListener("click", async () => {
      const examName = document.getElementById("examNameInput").value.trim();
      if (!examName) {
        alert("시험명을 입력해주세요.");
        return;
      }

      const response = await fetch("{% url 'omr_app:finalize_exam' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          exam_name: examName,
          data: extractedData,
        }),
      });

      const resData = await response.json();
      if (resData.status === "success") {
        alert("시험지 등록 완료!");
        window.location.href = resData.redirect_url;
      } else {
        alert("오류 발생: " + resData.message);
      }
    });
</script>

{% endblock %}
